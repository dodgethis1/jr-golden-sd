<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>JR Golden SD</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 16px; }
    .box { border: 1px solid #ccc; border-radius: 12px; padding: 12px; margin: 12px 0; }
    .warn { border-color: #b00; }
    .mode { font-size: 22px; font-weight: 800; }
    .pill { display:inline-block; padding: 2px 10px; border-radius: 999px; background:#f3f3f3; }
    code, pre { background: #f3f3f3; padding: 8px; border-radius: 10px; overflow:auto; }
    table { width: 100%; border-collapse: collapse; }
    td, th { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }
    input, select, button { font-size: 16px; padding: 8px; }
    button { cursor: pointer; }
  </style>
</head>
<body>
  <h2>JR Golden SD</h2>

  <div class="box" id="headline">Loading…</div>

  <div class="grid">
    <div class="box" id="urls">Loading URLs…</div>
    <div class="box" id="qr">Loading QR…</div>
  </div>

  <div class="box warn" id="policy">Loading policy…</div>

  <div class="box" id="planner">
    <b>Flash Plan (dry-run):</b><br><br>

    <label>Target disk (eligible only):<br>
      <select id="target"></select>
    </label>
    <br><br>

    <label>OS search:<br>
      <input id="q" placeholder="raspberry pi os, twister, ubuntu, home assistant…" style="width:100%">
    </label>
    <br><br>

    <label>OS choice (top 250 results):<br>
      <select id="os"></select>
    </label>
    <br><br>

    <button id="planBtn">Generate plan (dry-run)</button>
    <div id="planOut" style="margin-top:12px;"></div>
  </div>

<script>
async function j(url){ const r=await fetch(url); return await r.json(); }

function opt(el, value, text){
  const o = document.createElement("option");
  o.value = value; o.textContent = text;
  el.appendChild(o);
}

async function loadOS(q=""){
  const osSel = document.getElementById("os");
  osSel.innerHTML = "";
  const data = await j("/api/os" + (q ? ("?q=" + encodeURIComponent(q)) : ""));
  (data.items || []).forEach(it => {
    const label = `${it.name}  [${it.provider_label}]`;
    opt(osSel, it.id, label);
  });
}

(async () => {
  const h = await j("/api/health");
  document.getElementById("headline").innerHTML =
    `<div class="mode">MODE: <span class="pill">${h.mode}</span></div>
     <div><b>Version:</b> <code>${h.version}</code></div>
     <div><b>Root source:</b> <code>${h.root_source || "unknown"}</code></div>
     <div><b>Root parent:</b> <code>/dev/${h.root_parent || "unknown"}</code></div>`;

  const u = await j("/api/urls");
  const list = (u.urls || []).map(x => `<li><a href="${x}">${x}</a></li>`).join("");
  document.getElementById("urls").innerHTML = `<b>Open this from your phone/PC:</b><ul>${list || "<li>(no URLs detected)</li>"}</ul>`;
  const first = (u.urls && u.urls[0]) ? u.urls[0] : location.origin + "/";
  document.getElementById("qr").innerHTML =
    `<b>QR (scan me):</b><br><img src="/api/qr?u=${encodeURIComponent(first)}" alt="QR"><br><small><code>${first}</code></small>`;

  const s = await j("/api/safety");
  const p = s.policy;
  document.getElementById("policy").innerHTML =
    `<b>Safety policy:</b><br>
     Flash enabled: <span class="pill">${p.flash_enabled}</span><br>
     Can flash here (must be SD mode): <span class="pill">${p.can_flash_here}</span><br>
     Root disk blocked: <span class="pill">${p.root_disk_blocked}</span><br><br>
     <small>We will not enable flashing until the safety engine + confirmations are complete.</small>`;

  const tSel = document.getElementById("target");
  tSel.innerHTML = "";
  (s.eligible_targets || []).forEach(d => {
    const label = `${d.path} (${d.size || ""} ${d.model || ""} ${d.serial || ""})`;
    opt(tSel, d.path, label);
  });

  await loadOS("");

  document.getElementById("q").addEventListener("change", async (e) => {
    await loadOS(e.target.value || "");
  });

  document.getElementById("planBtn").addEventListener("click", async () => {
    const target = tSel.value;
    const os_id = document.getElementById("os").value;
    const r = await fetch("/api/plan_flash", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ target, os_id })
    });
    const data = await r.json();
    document.getElementById("planOut").innerHTML =
      `<b>Plan output:</b><pre>${JSON.stringify(data, null, 2)}</pre>`;
  });
})();
</script>
</body>
</html>
